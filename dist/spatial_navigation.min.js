/**
 * A javascript-based implementation of Spatial Navigation.
 *
 * Copyright (c) 2017 Luke Chang.
 * https://github.com/luke-chang/js-spatial-navigation
 *
 * @license Licensed under the MPL 2.0.
 */
!function(a){"use strict";function b(a){var b=a.getBoundingClientRect(),c={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};return c.element=a,c.center={x:c.left+Math.floor(c.width/2),y:c.top+Math.floor(c.height/2)},c.center.left=c.center.right=c.center.x,c.center.top=c.center.bottom=c.center.y,c}function c(a,b,c){for(var d=[[],[],[],[],[],[],[],[],[]],e=0;e<a.length;e++){var f,g,h,i=a[e],j=i.center;if(f=j.x<b.left?0:j.x<=b.right?1:2,g=j.y<b.top?0:j.y<=b.bottom?1:2,h=3*g+f,d[h].push(i),[0,2,6,8].indexOf(h)!==-1){var k=c;i.left<=b.right-b.width*k&&(2===h?d[1].push(i):8===h&&d[7].push(i)),i.right>=b.left+b.width*k&&(0===h?d[1].push(i):6===h&&d[7].push(i)),i.top<=b.bottom-b.height*k&&(6===h?d[3].push(i):8===h&&d[5].push(i)),i.bottom>=b.top+b.height*k&&(0===h?d[3].push(i):2===h&&d[5].push(i))}}return d}function d(a){return{nearPlumbLineIsBetter:function(b){var c;return c=b.center.x<a.center.x?a.center.x-b.right:b.left-a.center.x,c<0?0:c},nearHorizonIsBetter:function(b){var c;return c=b.center.y<a.center.y?a.center.y-b.bottom:b.top-a.center.y,c<0?0:c},nearTargetLeftIsBetter:function(b){var c;return c=b.center.x<a.center.x?a.left-b.right:b.left-a.left,c<0?0:c},nearTargetTopIsBetter:function(b){var c;return c=b.center.y<a.center.y?a.top-b.bottom:b.top-a.top,c<0?0:c},topIsBetter:function(a){return a.top},bottomIsBetter:function(a){return-1*a.bottom},leftIsBetter:function(a){return a.left},rightIsBetter:function(a){return-1*a.right}}}function e(a){for(var b=null,c=0;c<a.length;c++)if(a[c].group.length){b=a[c];break}if(!b)return null;var d=b.distance;return b.group.sort(function(a,b){for(var c=0;c<d.length;c++){var e=d[c],f=e(a)-e(b);if(f)return f}return 0}),b.group}function f(a,f,g,h){if(!(a&&f&&g&&g.length))return null;for(var i=[],j=0;j<g.length;j++){var k=b(g[j]);k&&i.push(k)}if(!i.length)return null;var l=b(a);if(!l)return null;var m,n=d(l),o=c(i,l,h.straightOverlapThreshold),p=c(o[4],l.center,h.straightOverlapThreshold);switch(f){case"left":m=[{group:p[0].concat(p[3]).concat(p[6]),distance:[n.nearPlumbLineIsBetter,n.topIsBetter]},{group:o[3],distance:[n.nearPlumbLineIsBetter,n.topIsBetter]},{group:o[0].concat(o[6]),distance:[n.nearHorizonIsBetter,n.rightIsBetter,n.nearTargetTopIsBetter]}];break;case"right":m=[{group:p[2].concat(p[5]).concat(p[8]),distance:[n.nearPlumbLineIsBetter,n.topIsBetter]},{group:o[5],distance:[n.nearPlumbLineIsBetter,n.topIsBetter]},{group:o[2].concat(o[8]),distance:[n.nearHorizonIsBetter,n.leftIsBetter,n.nearTargetTopIsBetter]}];break;case"up":m=[{group:p[0].concat(p[1]).concat(p[2]),distance:[n.nearHorizonIsBetter,n.leftIsBetter]},{group:o[1],distance:[n.nearHorizonIsBetter,n.leftIsBetter]},{group:o[0].concat(o[2]),distance:[n.nearPlumbLineIsBetter,n.bottomIsBetter,n.nearTargetLeftIsBetter]}];break;case"down":m=[{group:p[6].concat(p[7]).concat(p[8]),distance:[n.nearHorizonIsBetter,n.leftIsBetter]},{group:o[7],distance:[n.nearHorizonIsBetter,n.leftIsBetter]},{group:o[6].concat(o[8]),distance:[n.nearPlumbLineIsBetter,n.topIsBetter,n.nearTargetLeftIsBetter]}];break;default:return null}h.straightOnly&&m.pop();var q=e(m);if(!q)return null;var r=null;if(h.rememberSource&&h.previous&&h.previous.destination===a&&h.previous.reverse===f)for(var s=0;s<q.length;s++)if(q[s].element===h.previous.target){r=q[s].element;break}return r||(r=q[0].element),r}function g(){for(var a;;)if(a=H+String(++I),!L[a])break;return a}function h(b){var c;return c=a?a(b).get():"string"==typeof b?[].slice.call(document.querySelectorAll(b)):"object"==typeof b&&b.length?[].slice.call(b):"object"==typeof b&&1===b.nodeType?[b]:[]}function i(b,c){return a?a(b).is(c):"string"==typeof c?Q.call(b,c):"object"==typeof c&&c.length?c.indexOf(b)>=0:"object"==typeof c&&1===c.nodeType&&b===c}function j(){var a=document.activeElement;if(a&&a!==document.body)return a}function k(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&void 0!==arguments[b][c]&&(a[c]=arguments[b][c]);return a}function l(a,b){Array.isArray(b)||(b=[b]);for(var c,d=0;d<b.length;d++)c=a.indexOf(b[d]),c>=0&&a.splice(c,1);return a}function m(a,b,c){if(!a||!b||!L[b]||L[b].disabled)return!1;if(a.offsetWidth<=0&&a.offsetHeight<=0||a.hasAttribute("disabled"))return!1;if(c&&!i(a,L[b].selector))return!1;if("function"==typeof L[b].navigableFilter){if(L[b].navigableFilter(a,b)===!1)return!1}else if("function"==typeof D.navigableFilter&&D.navigableFilter(a,b)===!1)return!1;return!0}function n(a){for(var b in L)if(!L[b].disabled&&i(a,L[b].selector))return b}function o(a){return h(L[a].selector).filter(function(b){return m(b,a)})}function p(b){var c=L[b].defaultElement;return c?("string"==typeof c?c=h(c)[0]:a&&c instanceof a&&(c=c.get(0)),m(c,b,!0)?c:null):null}function q(a){var b=L[a].lastFocusedElement;return m(b,a,!0)?b:null}function r(a,b,c,d){arguments.length<4&&(d=!0);var e=document.createEvent("CustomEvent");return e.initCustomEvent(G+b,!0,d,c),a.dispatchEvent(e)}function s(a,b,c){if(!a)return!1;var d=j(),e=function(){d&&d.blur(),a.focus(),t(a,b)};if(P)return e(),!0;if(P=!0,K)return e(),P=!1,!0;if(d){var f={nextElement:a,nextSectionId:b,direction:c,native:!1};if(!r(d,"willunfocus",f))return P=!1,!1;d.blur(),r(d,"unfocused",f,!1)}var g={previousElement:d,sectionId:b,direction:c,native:!1};return r(a,"willfocus",g)?(a.focus(),r(a,"focused",g,!1),P=!1,t(a,b),!0):(P=!1,!1)}function t(a,b){b||(b=n(a)),b&&(L[b].lastFocusedElement=a,O=b)}function u(a,b){if("@"==a.charAt(0)){if(1==a.length)return v();var c=a.substr(1);return v(c)}var d=h(a)[0];if(d){var e=n(d);if(m(d,e))return s(d,e,b)}return!1}function v(a){var b=[],c=function(a){a&&b.indexOf(a)<0&&L[a]&&!L[a].disabled&&b.push(a)};a?c(a):(c(N),c(O),Object.keys(L).map(c));for(var d=0;d<b.length;d++){var e,f=b[d];if(e="last-focused"==L[f].enterTo?q(f)||p(f)||o(f)[0]:p(f)||q(f)||o(f)[0])return s(e,f)}return!1}function w(a,b){r(a,"navigatefailed",{direction:b},!1)}function x(b,c){if(L[b].leaveFor&&void 0!==L[b].leaveFor[c]){var d=L[b].leaveFor[c];if("string"==typeof d)return""===d?null:u(d,c);a&&d instanceof a&&(d=d.get(0));var e=n(d);if(m(d,e))return s(d,e,c)}return!1}function y(a,b,c){var d=b.getAttribute("data-sn-"+a);if("string"==typeof d)return!(""===d||!u(d,a))||(w(b,a),!1);var e={},g=[];for(var h in L)e[h]=o(h),g=g.concat(e[h]);var i,j=k({},D,L[c]);if("self-only"==j.restrict||"self-first"==j.restrict){var m=e[c];i=f(b,a,l(m,b),j),i||"self-first"!=j.restrict||(i=f(b,a,l(g,m),j))}else i=f(b,a,l(g,b),j);if(i){L[c].previous={target:b,destination:i,reverse:F[a]};var r=n(i);if(c!=r){var t=x(c,a);if(t)return!0;if(null===t)return w(b,a),!1;var v;switch(L[r].enterTo){case"last-focused":v=q(r)||p(r);break;case"default-element":v=p(r)}v&&(i=v)}return s(i,r,a)}return!!x(c,a)||(w(b,a),!1)}function z(a){if(M&&!K){var b,c=function(){return a.preventDefault(),a.stopPropagation(),!1},d=E[a.keyCode];if(d){if(b=j(),!b&&(O&&(b=q(O)),!b))return v(),c();var e=n(b);if(e){var f={direction:d,sectionId:e,cause:"keydown"};return r(b,"willmove",f)&&y(d,b,e),c()}}else if(13==a.keyCode&&(b=j(),b&&n(b)&&!r(b,"enter-down")))return c()}}function A(a){if(!K&&M&&13==a.keyCode){var b=j();b&&n(b)&&(r(b,"enter-up")||(a.preventDefault(),a.stopPropagation()))}}function B(a){var b=a.target;if(b!==window&&b!==document&&M&&!P){var c=n(b);if(c){if(K)return void t(b,c);var d={sectionId:c,native:!0};r(b,"willfocus",d)?(r(b,"focused",d,!1),t(b,c)):(P=!0,b.blur(),P=!1)}}}function C(a){var b=a.target;if(b!==window&&b!==document&&!K&&M&&!P&&n(b)){var c={native:!0};r(b,"willunfocus",c)?r(b,"unfocused",c,!1):(P=!0,setTimeout(function(){b.focus(),P=!1}))}}var D={selector:"",straightOnly:!1,straightOverlapThreshold:.5,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:"a, input, select, textarea, button, iframe, [contentEditable=true]",navigableFilter:null},E={37:"left",38:"up",39:"right",40:"down"},F={left:"right",up:"down",right:"left",down:"up"},G="sn:",H="section-",I=0,J=!1,K=!1,L={},M=0,N="",O="",P=!1,Q=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(a){var b=(this.parentNode||this.document).querySelectorAll(a);return[].slice.call(b).indexOf(this)>=0},R={init:function(){J||(window.addEventListener("keydown",z),window.addEventListener("keyup",A),window.addEventListener("focus",B,!0),window.addEventListener("blur",C,!0),J=!0)},uninit:function(){window.removeEventListener("blur",C,!0),window.removeEventListener("focus",B,!0),window.removeEventListener("keyup",A),window.removeEventListener("keydown",z),R.clear(),I=0,J=!1},clear:function(){L={},M=0,N="",O="",P=!1},set:function(){var a,b;if("object"==typeof arguments[0])b=arguments[0];else{if("string"!=typeof arguments[0]||"object"!=typeof arguments[1])return;if(a=arguments[0],b=arguments[1],!L[a])throw new Error('Section "'+a+"\" doesn't exist!")}for(var c in b)void 0!==D[c]&&(a?L[a][c]=b[c]:void 0!==b[c]&&(D[c]=b[c]));a&&(L[a]=k({},L[a]))},add:function(){var a,b={};if("object"==typeof arguments[0]?b=arguments[0]:"string"==typeof arguments[0]&&"object"==typeof arguments[1]&&(a=arguments[0],b=arguments[1]),a||(a="string"==typeof b.id?b.id:g()),L[a])throw new Error('Section "'+a+'" has already existed!');return L[a]={},M++,R.set(a,b),a},remove:function(a){if(!a||"string"!=typeof a)throw new Error('Please assign the "sectionId"!');return!!L[a]&&(L[a]=void 0,L=k({},L),M--,!0)},disable:function(a){return!!L[a]&&(L[a].disabled=!0,!0)},enable:function(a){return!!L[a]&&(L[a].disabled=!1,!0)},pause:function(){K=!0},resume:function(){K=!1},focus:function(b,c){var d=!1;void 0===c&&"boolean"==typeof b&&(c=b,b=void 0);var e=!K&&c;if(e&&R.pause(),b)if("string"==typeof b)d=L[b]?v(b):u(b);else{a&&b instanceof a&&(b=b.get(0));var f=n(b);m(b,f)&&(d=s(b,f))}else d=v();return e&&R.resume(),d},move:function(a,b){if(a=a.toLowerCase(),!F[a])return!1;var c=b?h(b)[0]:j();if(!c)return!1;var d=n(c);if(!d)return!1;var e={direction:a,sectionId:d,cause:"api"};return!!r(c,"willmove",e)&&y(a,c,d)},makeFocusable:function(a){var b=function(a){var b=void 0!==a.tabIndexIgnoreList?a.tabIndexIgnoreList:D.tabIndexIgnoreList;h(a.selector).forEach(function(a){i(a,b)||a.getAttribute("tabindex")||a.setAttribute("tabindex","-1")})};if(a){if(!L[a])throw new Error('Section "'+a+"\" doesn't exist!");b(L[a])}else for(var c in L)b(L[c])},setDefaultSection:function(a){if(a){if(!L[a])throw new Error('Section "'+a+"\" doesn't exist!");N=a}else N=""}};window.SpatialNavigation=R,a&&(a.SpatialNavigation=function(){if(R.init(),arguments.length>0){if(a.isPlainObject(arguments[0]))return R.add(arguments[0]);if("string"===a.type(arguments[0])&&a.isFunction(R[arguments[0]]))return R[arguments[0]].apply(R,[].slice.call(arguments,1))}return a.extend({},R)},a.fn.SpatialNavigation=function(){var b;return b=a.isPlainObject(arguments[0])?arguments[0]:{id:arguments[0]},b.selector=this,R.init(),b.id&&R.remove(b.id),R.add(b),R.makeFocusable(b.id),this})}(window.jQuery);